<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Hệ thống thi trắc nghiệm – BẢN ĐÃ FIX</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--bg:#f1f5f9;--card:#fff;--primary:#2563eb;--danger:#dc2626}
body{margin:0;font-family:Segoe UI,Arial;background:var(--bg)}
header{background:var(--primary);color:#fff;padding:14px;text-align:center;font-size:20px;font-weight:600}
.container{max-width:1000px;margin:auto;padding:20px}
.card{background:var(--card);border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 5px 20px rgba(0,0,0,.08)}
input,select,textarea,button{padding:10px;margin:6px 0;width:100%;box-sizing:border-box}
textarea{min-height:80px}
button{background:var(--primary);color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer}
button.danger{background:var(--danger)}
.hidden{display:none}
.question{margin-bottom:15px}
.timer{font-size:18px;color:#dc2626;font-weight:bold}
.tabwarn{color:#dc2626;font-weight:600}
</style>
</head>
<body>
<header>HỆ THỐNG THI TRẮC NGHIỆM ONLINE</header>
<div class="container">

<div id="login" class="card">
<h3>Đăng nhập</h3>
<select id="role">
<option value="student">Học sinh</option>
<option value="teacher">Giáo viên</option>
</select>
<input id="username" placeholder="Tên đăng nhập">
<button onclick="login()">Đăng nhập</button>
</div>

<div id="teacher" class="card hidden">
<h3>Giáo viên – Tạo đề</h3>
<input id="examTitle" placeholder="Tên đề thi">
<input id="examTime" type="number" placeholder="Thời gian (phút)">
<input id="sessionName" placeholder="Tên ca thi">
<hr>
<textarea id="questionText" placeholder="Nội dung câu hỏi"></textarea>
<input id="a" placeholder="Đáp án A">
<input id="b" placeholder="Đáp án B">
<input id="c" placeholder="Đáp án C">
<input id="d" placeholder="Đáp án D">
<select id="correct"><option>A</option><option>B</option><option>C</option><option>D</option></select>
<button onclick="addQuestion()">Thêm câu hỏi</button>
<button onclick="publishExam()">Lưu đề</button>
<p id="teacherMsg"></p>
</div>

<div id="student" class="card hidden">
<h3 id="examName"></h3>
<p id="sessionInfo"></p>
<div class="timer" id="timer"></div>
<div id="warn" class="tabwarn"></div>
<form id="examForm"></form>
<button class="danger" onclick="submitExam()">Nộp bài</button>
</div>

<div id="result" class="card hidden">
<h3>Kết quả</h3>
<p>Thí sinh: <b id="stuName"></b></p>
<p>Điểm: <b id="scoreText"></b></p>
<button onclick="exportExcel()">Xuất Excel</button>
</div>

</div>
<script>
let questions=[], exam={}, timeLeft=0, tabCount=0;

function login(){
 const name=document.getElementById('username').value.trim();
 if(!name){alert('Nhập tên');return;}
 localStorage.setItem('user',name);
 document.getElementById('login').classList.add('hidden');
 if(document.getElementById('role').value==='teacher'){
  document.getElementById('teacher').classList.remove('hidden');
 }else{
  loadExam();
 }
}

function addQuestion(){
 questions.push({q:questionText.value,A:a.value,B:b.value,C:c.value,D:d.value,correct:correct.value});
 teacherMsg.innerText='Đã thêm '+questions.length+' câu';
 questionText.value=a.value=b.value=c.value=d.value='';
}

function publishExam(){
 exam={title:examTitle.value,time:parseInt(examTime.value||1)*60,session:sessionName.value,questions:questions};
 localStorage.setItem('exam',JSON.stringify(exam));
 teacherMsg.innerText='Đề đã lưu, học sinh có thể thi';
}

function loadExam(){
 exam=JSON.parse(localStorage.getItem('exam'));
 if(!exam){alert('Chưa có đề thi');location.reload();return;}
 document.getElementById('student').classList.remove('hidden');
 examName.innerText=exam.title;
 sessionInfo.innerText='Ca thi: '+exam.session;
 questions=[...exam.questions].sort(()=>Math.random()-0.5);
 examForm.innerHTML='';
 questions.forEach((q,i)=>{
  let opts=['A','B','C','D'].sort(()=>Math.random()-0.5);
  examForm.innerHTML+=`<div class='question'><p>${i+1}. ${q.q}</p>`+
   opts.map(k=>`<label><input type='radio' name='q${i}' value='${k}'> ${k}. ${q[k]}</label><br>`).join('')+`</div>`;
 });
 timeLeft=exam.time;
 countdown();
 monitorTab();
}

function countdown(){
 const t=setInterval(()=>{
  timer.innerText='Thời gian còn: '+timeLeft+' giây';
  timeLeft--;
  if(timeLeft<0){clearInterval(t);submitExam();}
 },1000);
}

function monitorTab(){
 document.addEventListener('visibilitychange',()=>{
  if(document.hidden){tabCount++; warn.innerText='Cảnh báo thoát tab: '+tabCount;}
 });
}

function submitExam(){
 let totalScore=0;
 questions.forEach((q,i)=>{
  let ans=document.querySelector(`input[name=q${i}]:checked`);
  if(ans && ans.value===q.correct) totalScore++;
 });
 localStorage.setItem('result',JSON.stringify({name:localStorage.getItem('user'),score:totalScore,total:questions.length}));
 document.getElementById('student').classList.add('hidden');
 showResult();
}

function showResult(){
 const r=JSON.parse(localStorage.getItem('result'));
 document.getElementById('result').classList.remove('hidden');
 stuName.innerText=r.name;
 scoreText.innerText=r.score+'/'+r.total;
}

function exportExcel(){
 const r=JSON.parse(localStorage.getItem('result'));
 const csv='Tên,Điểm\n'+r.name+','+r.score+'/'+r.total;
 const blob=new Blob([csv],{type:'text/csv'});
 const a=document.createElement('a');
 a.href=URL.createObjectURL(blob);
 a.download='ket_qua.csv';
 a.click();
}
</script>
</body>
</html>
